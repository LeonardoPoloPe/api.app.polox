/**
 * ==========================================
 * üõ£Ô∏è ROTAS B√ÅSICAS API POLOX
 * ==========================================
 */

const express = require("express");
const AuthController = require("./controllers/authController");
const UserController = require("./controllers/userController");

// Middleware e valida√ß√µes
const { authenticateToken } = require("./middleware/auth");

// Importar rotas espec√≠ficas
const companiesRoutes = require("./routes/companies");
const gamificationRoutes = require("./routes/gamification");
const leadsRoutes = require("./routes/leads");
const clientsRoutes = require("./routes/clients");
const salesRoutes = require("./routes/sales");
const productsRoutes = require("./routes/products");
const financeRoutes = require("./routes/finance");
const ticketsRoutes = require("./routes/tickets");
const notificationsRoutes = require("./routes/notifications");
const scheduleRoutes = require("./routes/schedule");
const suppliersRoutes = require("./routes/suppliers");
const analyticsRoutes = require("./routes/analytics");

const router = express.Router();

// ==========================================
// üìö CONFIGURA√á√ÉO DO SWAGGER
// ==========================================
if (process.env.NODE_ENV !== "production") {
  try {
    const swaggerUi = require("swagger-ui-express");
    const swaggerJsdoc = require("swagger-jsdoc");
    
    const swaggerOptions = {
      definition: {
        openapi: "3.0.0",
        info: {
          title: "Polox CRM API",
          version: "1.0.0",
          description: "API Enterprise Multi-Tenant para CRM com Gamifica√ß√£o",
          contact: {
            name: "Polox Team",
            email: "suporte@polox.com.br",
          },
        },
        servers: [
          {
            url: "http://localhost:3000/dev/api",
            description: "Servidor de Desenvolvimento (Serverless Offline)",
          },
          {
            url: "http://localhost:3000/api",
            description: "Servidor Local (Node.js)",
          },
        ],
        components: {
          securitySchemes: {
            bearerAuth: {
              type: "http",
              scheme: "bearer",
              bearerFormat: "JWT",
            },
          },
        },
        security: [
          {
            bearerAuth: [],
          },
        ],
      },
      apis: [
        "./src/routes.js",
        "./src/routes/*.js",
        "./src/controllers/*.js",
      ],
    };

    const swaggerSpec = swaggerJsdoc(swaggerOptions);
    
    // Rota para a UI do Swagger
    router.use("/docs", swaggerUi.serve);
    router.get("/docs", swaggerUi.setup(swaggerSpec, {
      customCss: '.swagger-ui .topbar { display: none }',
      customSiteTitle: "Polox API Docs",
    }));
    
    // Rota para o JSON do Swagger
    router.get("/docs.json", (req, res) => {
      res.setHeader("Content-Type", "application/json");
      res.send(swaggerSpec);
    });
    
    console.log("üìö Swagger configurado em /api/docs");
  } catch (error) {
    console.warn("‚ö†Ô∏è  Swagger n√£o p√¥de ser carregado:", error.message);
  }
}

// ==========================================
// ÔøΩ CONFIGURA√á√ÉO DO SWAGGER MOVIDA PARA /config/swagger.js
// ==========================================

// ==========================================
// üîê ROTAS DE AUTENTICA√á√ÉO
// ==========================================

/**
 * @swagger
 * /auth/login:
 *   post:
 *     summary: Login de usu√°rio
 *     tags: [Autentica√ß√£o]
 *     security: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - email
 *               - password
 *             properties:
 *               email:
 *                 type: string
 *                 format: email
 *               password:
 *                 type: string
 *                 minLength: 6
 *               rememberMe:
 *                 type: boolean
 *                 default: false
 *     responses:
 *       200:
 *         description: Login realizado com sucesso
 *       401:
 *         description: Credenciais inv√°lidas
 */
router.post("/auth/login", AuthController.login);

/**
 * @swagger
 * /auth/register:
 *   post:
 *     summary: Registrar novo usu√°rio
 *     tags: [Autentica√ß√£o]
 *     security: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - name
 *               - email
 *               - password
 *             properties:
 *               name:
 *                 type: string
 *               email:
 *                 type: string
 *                 format: email
 *               password:
 *                 type: string
 *                 minLength: 6
 *     responses:
 *       201:
 *         description: Usu√°rio criado com sucesso
 */
router.post("/auth/register", AuthController.register);

/**
 * @swagger
 * /auth/logout:
 *   post:
 *     summary: Logout do usu√°rio
 *     tags: [Autentica√ß√£o]
 *     responses:
 *       200:
 *         description: Logout realizado com sucesso
 */
router.post("/auth/logout", authenticateToken, AuthController.logout);

/**
 * @swagger
 * /auth/refresh:
 *   post:
 *     summary: Renovar token de acesso
 *     tags: [Autentica√ß√£o]
 *     security: []
 *     responses:
 *       200:
 *         description: Token renovado com sucesso
 */
router.post("/auth/refresh", AuthController.refreshToken);

// ==========================================
// üë§ ROTAS DE USU√ÅRIO
// ==========================================

/**
 * @swagger
 * /users:
 *   get:
 *     summary: Listar usu√°rios
 *     tags: [Usu√°rios]
 *     responses:
 *       200:
 *         description: Lista de usu√°rios
 */
router.get("/users", authenticateToken, UserController.getUsers);

/**
 * @swagger
 * /users/profile:
 *   get:
 *     summary: Obter perfil do usu√°rio logado
 *     tags: [Usu√°rios]
 *     responses:
 *       200:
 *         description: Perfil do usu√°rio
 */
router.get("/users/profile", authenticateToken, UserController.getProfile);

/**
 * @swagger
 * /users/profile:
 *   put:
 *     summary: Atualizar perfil do usu√°rio logado
 *     tags: [Usu√°rios]
 *     responses:
 *       200:
 *         description: Perfil atualizado com sucesso
 */
router.put("/users/profile", authenticateToken, UserController.updateProfile);

// ==========================================
// üè¢ ROTAS DE EMPRESAS (SUPER ADMIN)
// ==========================================
router.use("/companies", companiesRoutes);

// ==========================================
// üéÆ ROTAS DE GAMIFICA√á√ÉO
// ==========================================
router.use("/gamification", gamificationRoutes);

// ==========================================
// üìà ROTAS DE LEADS (CRM)
// ==========================================
router.use("/leads", leadsRoutes);

// ==========================================
// üë• ROTAS DE CLIENTES
// ==========================================
router.use("/clients", clientsRoutes);

// ==========================================
// üí∞ ROTAS DE VENDAS
// ==========================================
router.use("/sales", salesRoutes);

// ==========================================
// üì¶ ROTAS DE PRODUTOS
// ==========================================
router.use("/products", productsRoutes);

// ==========================================
// üí≥ ROTAS DE FINAN√áAS
// ==========================================
router.use("/finance", financeRoutes);

// ==========================================
// üé´ ROTAS DE TICKETS/SUPORTE
// ==========================================
router.use("/tickets", ticketsRoutes);

// ==========================================
// üîî ROTAS DE NOTIFICA√á√ïES
// ==========================================
router.use("/notifications", notificationsRoutes);

// ==========================================
// üìÖ ROTAS DE AGENDAMENTOS
// ==========================================
router.use("/schedule", scheduleRoutes);

// ==========================================
// üè≠ ROTAS DE FORNECEDORES
// ==========================================
router.use("/suppliers", suppliersRoutes);

// ==========================================
// üìä ROTAS DE ANALYTICS/RELAT√ìRIOS
// ==========================================
router.use("/analytics", analyticsRoutes);

// ==========================================
// üéØ ROTAS DE DEMONSTRA√á√ÉO E TESTES
// ==========================================

/**
 * @swagger
 * /demo/public:
 *   get:
 *     summary: Rota p√∫blica de demonstra√ß√£o
 *     description: Endpoint p√∫blico para testar a API sem autentica√ß√£o
 *     tags: [Demo]
 *     security: []
 *     responses:
 *       200:
 *         description: Resposta de demonstra√ß√£o p√∫blica
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 message:
 *                   type: string
 *                   example: Esta √© uma rota p√∫blica de demonstra√ß√£o
 *                 timestamp:
 *                   type: string
 *                   format: date-time
 *                   example: 2025-10-18T22:30:00Z
 *                 environment:
 *                   type: string
 *                   example: dev
 */
router.get("/demo/public", (req, res) => {
  res.json({
    message: "Esta √© uma rota p√∫blica de demonstra√ß√£o",
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || "dev",
    version: "1.0.0",
    api: "Polox CRM API",
    status: "‚úÖ Funcionando perfeitamente!",
  });
});

/**
 * @swagger
 * /demo/protected:
 *   get:
 *     summary: Rota protegida de demonstra√ß√£o
 *     description: Endpoint que requer autentica√ß√£o para testar o middleware
 *     tags: [Demo]
 *     responses:
 *       200:
 *         description: Resposta de demonstra√ß√£o protegida
 *       401:
 *         description: Token n√£o fornecido ou inv√°lido
 */
router.get("/demo/protected", authenticateToken, (req, res) => {
  res.json({
    message: "Esta √© uma rota protegida de demonstra√ß√£o",
    timestamp: new Date().toISOString(),
    user: {
      id: req.user.id,
      email: req.user.email,
      company_id: req.user.company_id,
    },
    environment: process.env.NODE_ENV || "dev",
    version: "1.0.0",
    status: "üîê Acesso autorizado!",
  });
});

module.exports = router;
