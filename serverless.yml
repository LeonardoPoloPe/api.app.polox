service: api-app-polox

frameworkVersion: "3"

# Configura√ß√µes de empacotamento otimizadas com esbuild
package:
  individually: false
  patterns:
    - "!**"

    # Inclus√µes cr√≠ticas para o Swagger e Rotas
    - "src/routes/**"
    - "src/controllers/**"
    - "src/handler.js"
    - "src/routes.js"
    - "src/models/**" # Inclui modelos como database.js
    - "src/middleware/**" # Inclui middlewares como auth.js
    - "src/utils/**" # Inclui utilit√°rios como logger.js
    - "swagger.js"

    # üí° CORRE√á√ÉO CR√çTICA DO ERRO 500: Incluir arquivos de tradu√ß√£o para i18n
    - "src/locales/**"
    - "src/config/**" # üí° CR√çTICO: Corre√ß√£o do erro atual (database.js, i18n.js, etc.)

    # Inclus√µes de metadados
    - "package.json"
    - "package-lock.json"

provider:
  name: aws
  runtime: nodejs18.x
  region: sa-east-1
  stage: ${opt:stage, 'dev'}
  timeout: 15
  memorySize: 512
  vpc:
    securityGroupIds:
      - sg-08caf7023512d2d69 # Security group do RDS
    subnetIds:
      - subnet-09e31f88ffe864c21 # Private subnet 1
      - subnet-05b6cbd90f2ca7c9d # Private subnet 2
      - subnet-0e39fb3446bf485c0 # Private subnet 3
  environment:
    NODE_ENV: ${self:provider.stage}
    DB_HOST: ${env:DB_HOST, 'database-1.cd2em8e0a6ot.sa-east-1.rds.amazonaws.com'}
    DB_PORT: 5432
    DB_NAME: ${self:custom.dbConfig.${self:provider.stage}.dbName}
    DB_USER: ${self:custom.dbConfig.${self:provider.stage}.dbUser}
    DB_PASSWORD: ${env:DB_PASSWORD, 'SenhaSeguraDev123!'}
    JWT_SECRET: ${env:JWT_SECRET, 'jwt_secret_dev_polox_2024_secure_key_development'}
    SKIP_MIGRATIONS: "true"
    TZ: UTC
    # Sentry Configuration
    SENTRY_DSN: "https://daf3479d9a3da6e76a5e3b03bf5d6e9d@o4510250740285440.ingest.de.sentry.io/4510250760077392"
    SENTRY_ENVIRONMENT: "${self:provider.stage}"
    SENTRY_RELEASE: "api-polox@${self:provider.stage}-v1.0.0"

custom:
  esbuild:
    bundle: true
    minify: false
    sourcemap: false
    exclude:
      - aws-sdk
    external:
      - pg-native
      - i18next-fs-backend
      - "@sentry/node"
      - serverless-http # üí° CORRE√á√ÉO CR√çTICA
      - express # üí° CR√çTICO: Corre√ß√£o do erro atual
      - cors # üí° CR√çTICO: Corre√ß√£o do erro atual
      - helmet # üí° CR√çTICO: Corre√ß√£o do erro atual
      - bcryptjs # üí° CR√çTICO: Corre√ß√£o do erro atual
      - jsonwebtoken # üí° CR√çTICO: Corre√ß√£o do erro atual
      - pg # üí° CR√çTICO: Adicionar m√≥dulo principal do PostgreSQL
      - i18next
      - dotenv
      - express-validator
      - joi
      - uuid
      - node-fetch
      - pg-pool
      - compression
      - morgan
      - multer
      - multer-s3
      - winston
      - redis
      - swagger-jsdoc
      - swagger-ui-express
      - moment
      - date-fns
      - hpp
      - xss-clean
      - express-mongo-sanitize
      - express-rate-limit
      - express-slow-down
      - prom-client
      - fast-glob
      - node-cron
      - i18next-http-middleware
      - nodemailer

    target: node18
    platform: node
    concurrency: 10
    packager: npm
    packagePath: package.json
    keepOutputDirectory: false

  dbConfig:
    dev:
      dbName: app_polox_dev
      dbUser: polox_dev_user
    sandbox:
      dbName: app_polox_sandbox
      dbUser: polox_sandbox_user
    prod:
      dbName: app_polox_prod
      dbUser: polox_prod_user

  serverless-offline:
    httpPort: 3000
    host: localhost
    noPrependStageInUrl: true
    ignoreJWTSignature: true

plugins:
  - serverless-esbuild
  - serverless-offline
  - serverless-dotenv-plugin

functions:
  api:
    handler: src/handler.handler
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors:
            origin: "*"
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - Accept
              - Accept-Language
              - Origin
              - X-Requested-With
            allowCredentials: true
            maxAge: 86400
      - http:
          path: /
          method: ANY
          cors:
            origin: "*"
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - Accept
              - Accept-Language
              - Origin
              - X-Requested-With
            allowCredentials: true
            maxAge: 86400

resources:
  Outputs:
    ApiEndpoint:
      Description: API Gateway endpoint URL
      Value:
        Fn::Join:
          - ""
          - - "https://"
            - Ref: ApiGatewayRestApi
            - ".execute-api."
            - ${aws:region}
            - ".amazonaws.com/"
            - ${self:provider.stage}

    DatabaseHost:
      Description: RDS Database Host
      Value: ${self:provider.environment.DB_HOST}

    DatabaseName:
      Description: Database Name for this stage
      Value: ${self:provider.environment.DB_NAME}
